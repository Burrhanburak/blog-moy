name: Deploy & Purge Cloudflare Cache

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: üöÄ Trigger Vercel Deploy
        run: |
          echo "Triggering Vercel deployment..."
          curl -X POST "https://api.vercel.com/v1/integrations/deploy/prj_S2oLxGOx61q6RR4gO4u6qBYJrdK1/Ad8AB5DP7l"

      - name: ‚è≥ Wait for deployment to finish
        run: |
          echo "Waiting 60 seconds for Vercel deployment to complete..."
          sleep 60

      - name: üî• Purge Cloudflare Cache
        run: |
          echo "Purging Cloudflare cache..."
          response=$(curl -s -X POST "https://blog.moydus.com/api/purge-cloudflare")
          echo "Response: $response"

          # Check if purge was successful
          if echo "$response" | grep -q "success"; then
            echo "‚úÖ Cloudflare cache purged successfully!"
          else
            echo "‚ùå Cache purge failed!"
            exit 1
          fi

      - name: ‚úÖ Deployment Complete
        run: |
          echo "üéâ Deployment and cache purge completed successfully!"
          echo "Site: https://blog.moydus.com"
